# 矿工

我们的矿工行为类似于交易员。为了获得高分和激励，他们在我们的系统中针对不同的交易对下**订单**。每个订单的规模由其**杠杆**决定，杠杆可以理解为用于交易的组合价值的百分比。杠杆为1.0倍的订单表示矿工正在用其整个组合价值进行交易。

当矿工首次在某个交易对上下单时，他们将开立一个**头寸**。该头寸的杠杆和方向性决定了矿工对该交易对未来走势的预期。只要该头寸保持开放，矿工就在传达对该交易对继续朝该方向运动的预期。头寸有两种类型：**多头**和**空头**。

多头头寸是对交易对上涨的押注，而空头头寸是对交易对下跌的押注。即使整体头寸为多头，矿工也可以在该头寸内提交多个订单，通过调整杠杆来管理其风险敞口。多头头寸上的空头订单将减少整体头寸的杠杆，从而减少矿工对该交易对的敞口。多头头寸上的多头订单将增加整体头寸的杠杆，从而增加矿工对该交易对的敞口。

## 基本规则
1. 您的矿工在进入时将开始挑战期。矿工必须在90天内表现出持续的表现才能通过挑战期。在此期间，他们将获得少量TAO，以帮助他们避免被注销。通过挑战期的最低要求：
   - 相对于主要比赛中的矿工，得分达到或超过第75百分位。详细信息可以在[这里](https://docs.taoshi.io/tips/p13/)找到。
   - 至少有60个完整的交易日
   - 最大回撤不超过10%

2. 通过挑战期的矿工如果回撤超过10%，将被淘汰。
3. 每个交易对，矿工最多只能有一个开放的头寸。已平仓的头寸数量没有限制。
4. 如果矿工在市场时间之外下单，订单将被忽略。
5. 如果矿工被限速（恶意发送过多请求），其订单将被忽略。
6. 订单之间有10秒的冷却期，在此期间矿工不能下另一个订单。

## 评分细节

PTN依靠多个评分指标来构建一个全面的*风险调整后回报*衡量标准。在实践中，这些指标通常高度相关，但每个指标都提供了一个独特的视角来评估矿工。

虽然回报是一个重要的评分机制，但我们也使用惩罚来优先考虑交易的不同方面，例如矿工承担的风险或他们参与高风险策略的可能性。

我们计算所有头寸和整个组合的每日回报，时间跨度为UTC时间12:00 AM到次日12:00 AM。然而，如果交易日仍在进行中，我们仍然会实时监控表现和风险。

这种每日计算和评估框架与现实世界的金融实践紧密一致，使得能够准确、一致且有意义地衡量和比较不同策略的表现。即使对于交易不同资产类别和不同交易频率的策略，这种方法仍然有效。这种方法还可以提高策略波动性测量的精度。

年化用于夏普比率、索提诺比率和风险调整后的回报，其中波动性或回报被年化，以更好地评估策略的长期价值并标准化我们的指标。在确定正确的年化因子时，我们略微加权最近的交易日，而不是较旧的交易日。这应该鼓励矿工定期更新他们的策略并适应不断变化的市场条件，持续为网络提供最相关的信号。最近的每日回报相对于最旧的每日回报的重要性约为2.5倍，随着时间的推移呈指数递减。

此外，使用年化无风险利率（T-bills）进行归一化进一步标准化了我们的指标，使我们能够在更一致的基础上衡量矿工的表现。


### 评分指标

我们使用五个评分指标来根据每日回报评估矿工：**卡尔玛比率**、**夏普比率**、**欧米茄比率**、**索提诺比率**和**统计置信度（T统计量）**。

用于风险调整后回报的矿工风险是矿工的最大组合回撤。

_卡尔玛比率_将查看过去90天的每日回报，并通过最大回撤进行归一化。

$$
\text{回报 / 回撤} = \frac{(\frac{365}{n}\sum_{i=0}^n{R_i}) - R_{rf}}{\sum_i^{n}{\text{MDD}_i} / n}
$$

_夏普比率_将查看年化超额回报，回报通过无风险利率归一化，除以年化波动率，即回报的标准差。为了避免在底部进行游戏，波动率的最小值为1%。

$$
\text{夏普} = \frac{(\frac{365}{n}\sum_{i=0}^n{R_i}) - R_{rf}}{\sqrt{\text{var}{(R) * \frac{365}{n}}}}
$$

_欧米茄比率_是衡量赢利天数与亏损天数的比率。分子是正每日对数回报的总和，而分母是负每日对数回报的乘积。它可以作为矿工每天愿意承担的风险与回报比的有用代理。与夏普比率一样，我们将分母的最小值设为1%。

$$
\text{欧米茄} = \frac{\sum_{i=1}^n \max(r_i, 0)}{\lvert \sum_{i=1}^n \min(r_i, 0) \rvert}
$$

_索提诺比率_与夏普比率类似，只是分母，即年化波动率，仅使用负每日回报（即亏损日）计算。

$$
\text{索提诺} = \frac{(\frac{365}{n}\sum_{i=0}^n{R_i}) - R_{rf}}{\sqrt{\frac{365}{n} \cdot \text{var}(R_i \;|\; R_i < 0)}}
$$

_统计置信度_使用t统计量来衡量每日回报分布与均值为零的正态分布的相似程度。相似度低意味着矿工的策略与随机分布有更高的统计差异。

$$
t = \frac{\bar{R} - \mu}{s / \sqrt{n}}
$$

| 指标                  | 评分权重 |
|-------------------------|----------------|
| 卡尔玛比率            | 20%            |
| 夏普比率            | 20%            |
| 欧米茄比率             | 20%            |
| 索提诺比率 		        | 20%            
| 统计置信度	 | 20%	           |

### 评分惩罚

每个矿工有两个主要惩罚：

1. 最大回撤：PTN会淘汰回撤超过10%的矿工。
2. 马丁格尔策略：矿工如果持有类似于马丁格尔策略的头寸，将受到惩罚。当头寸有未实现亏损时，两个或更多增加杠杆超过已见最大杠杆的订单可能会导致惩罚。更多详细信息可以在[这里](https://docs.taoshi.io/tips/p15/)找到。

最大回撤惩罚和马丁格尔惩罚帮助我们实时检测矿工交易策略的绝对和相对风险。


### 费用和交易成本
我们希望为矿工模拟真实的交易成本，以使PTN的信号在我们的平台之外更有价值。为此，我们纳入了两个主要成本：**持仓成本**和**滑点**。

持仓成本反映了真实交易所的情况，以及他们如何管理隔夜持仓的成本。该费率根据资产类别的不同而变化，其逻辑可以在[我们的提案4](https://docs.taoshi.io/tips/p4/)中找到。

滑点成本用于估计交易的预期价格（通常是最后交易价格或最佳买卖价的中点）与其实际执行价格之间的差异。对于较大的订单，以及流动性较低和波动性较高的资产，该成本更高。更多信息请参阅[提案16](https://docs.taoshi.io/tips/p16/)。

##### 实施细节
| 市场   | 费用周期     | 时间                   | 应用费率       | 三重星期三 |
|----------|----------------|-------------------------|---------------------|------------------|
| 外汇    | 24小时            | 21:00 UTC               | 周一至周五             | ✓                |
| 加密货币   | 8小时             | 04:00, 12:00, 20:00 UTC | 每日（周一至周日）     |                  |
| 股票 | 24小时            | 21:00 UTC               | 周一至周五             | ✓                |

费用的幅度将反映以下分布：

| 市场   | 基础费率（年化） | 每日费率计算     |
|----------|--------------------|----------------------------|
| 外汇    | 3%                 | 0.008% * 最大杠杆 |
| 加密货币   | 10.95%             | 0.03% * 最大杠杆  |
| 股票 | 5.25%              | 0.014% * 最大杠杆 |

### 杠杆限制
我们还设置了杠杆使用限制，以确保网络具有一定的风险保护和对幼稚策略的缓解。[头寸杠杆限制](https://docs.taoshi.io/tips/p5/)如下：

| 市场   | 杠杆限制 |
|----------|----------------|
| 外汇    | 0.1x - 5x      |
| 加密货币   | 0.01x - 0.5x   |
| 股票 | 0.1x - 3x      |

我们还实施了[组合级别杠杆限制](https://docs.taoshi.io/tips/p10/)，即所有开放头寸的杠杆总和。该限制设置为“典型”头寸的10倍，其中典型头寸为外汇1倍杠杆，股票2倍杠杆，加密货币0.1倍杠杆。因此，您可以开设10个外汇头寸，每个1倍杠杆，5个股票头寸，每个2倍杠杆，5个外汇头寸，每个2倍杠杆，5个外汇头寸，每个1倍杠杆和5个加密货币头寸，每个0.1倍杠杆，等等。

## 激励分配
矿工在每个类别中根据其过去的头寸在回溯期内的表现进行评分。然后对这些分数应用惩罚，并根据矿工的总分进行排名。每个类别确定百分位数，如果矿工在某个类别中表现最差，其总分将减少该类别的全部评分权重。

例如，如果矿工在长期实现回报类别中排名最后，他们将在该类别中获得0%的分数。这将有效地将其分数降至0，并在下一轮注销中优先考虑他们。

我们使用[softmax函数](https://docs.taoshi.io/tips/p11/)进行分配，目标是前40%的矿工获得90%的排放量。softmax函数根据矿工的分数动态调整，将更多的激励分配给相对表现较高的矿工。

# 挖矿基础设施

在挖矿方面，我们为您设置了一些有用的基础设施，以便向网络发送信号。脚本`mining/run_receive_signals_server.py`将启动一个flask服务器来接收订单信号。

我们建议使用此flask服务器向网络发送信号。要查看向服务器发送信号的示例，请使用`mining/sample_signal_request.py`。

一旦信号成功发送到信号服务器，它将被解析并存储在本地`mining/received_signals`中，准备由`neurons/miner.py`处理。从那里，`neurons/miner.py`中的核心矿工逻辑将自动尝试将信号发送到网络上的验证器，失败时重试。一旦信号成功发送到网络并由验证器确认，信号将存储在`mining/processed_signals`中。否则，它将存储在`mining/failed_signals`中，并附带有关哪些验证器未收到信号的调试信息。

当前的信息流如下：

1. 运行`mining/run_receive_signals_server.py`和`neurons/miner.py`以接收和解析信号
2. 从您选择的数据提供商（TradingView、python脚本、手动运行`mining/sample_signal_request.py`）发送订单信号
3. 允许矿工自动将您的信号发送给验证器
4. 验证器根据您的信号更新现有头寸或创建新头寸
5. 验证器跟踪您的头寸回报
6. 验证器每隔几秒审查您的头寸以评估回撤，以确定是否应淘汰矿工（有关更多信息，请参阅主README）
7. 验证器等待您发送信号以平仓（FLAT）
8. 验证器每5分钟根据组合表现（包括开放和已平仓的头寸）设置权重。

在设置时，我们建议在本地运行`mining/run_receive_signals_server.py`和`mining/sample_signal_request.py`，以验证订单信号可以正确创建和解析。

之后，我们建议在测试网上运行`mining/run_receive_signals_server.py`和`mining/sample_signal_request.py`以及`neurons/miner.py`。检查日志输出以确保验证器收到您的订单。确保您在预期的环境中并添加适当的测试网标志。

| 环境 | Netuid |
| ----------- | -----: |
| 主网     |      8 |
| 测试网     |    116 |

让矿工向验证器提交订单的最简单方法是手动运行`mining/sample_signal_request.py`。然而，我们预计大多数顶级矿工将将其现有的交易软件与`neurons/miner.py`和`mining/run_receive_signals_server.py`接口，以自动发送交易信号。我们将很快发布有关如何设置自动交易的更详细指南。

**危险**

- 不要暴露您的私钥。
- 仅使用您的测试网钱包。
- 不要重复使用主网钱包的密码。
- 确保您的激励机制能够抵抗滥用。
- 您的激励机制对任何人开放。它们会发出真实的TAO。创建这些机制会产生TAO的锁定成本。
- 在尝试在主网上注册之前，我们强烈建议您在测试网上运行矿工。
- 矿工应直接使用真实交易所价格进行训练和实时数据目的。这应来自MT5和CB Pro / Binance。他们不应依赖验证器提供的数据源来获取价格，因为这些数据可能会根据潜在的停机时间和回退逻辑而变化。

# 系统要求

- 需要**Python 3.10**。
- [Bittensor](https://github.com/opentensor/bittensor#install)

以下是矿工的先决条件。您可能能够在较低的规格下运行矿工，但不建议这样做。

- 2 vCPU + 8 GB内存
- 使用CPU运行矿工

# 入门

## 1. 安装PTN

克隆仓库

```bash
git clone https://github.com/taoshidev/proprietary-trading-network.git
```

更改目录

```bash
cd proprietary-trading-network
```

创建虚拟环境

```bash
python3 -m venv venv
```

激活虚拟环境

```bash
. venv/bin/activate
```

禁用pip缓存

```bash
export PIP_NO_CACHE_DIR=1
```

安装依赖项

```bash
pip install -r requirements.txt
```

注意：在此之后，您应该忽略任何关于更新Bittensor的警告。我们希望使用`requirements.txt`中指定的版本。

创建本地和可编辑安装

```bash
python3 -m pip install -e .
```

创建`mining/miner_secrets.json`并将xxxx替换为您的API密钥。API密钥值由您决定，并且需要与`mining/sample_signal_request.py`中的值匹配。

```json
{
	"api_key": "xxxx"
}
```

## 2. 创建钱包

此步骤为您的矿工创建本地冷密钥和热密钥对。

矿工将注册到指定的子网。这确保矿工可以运行相应的矿工脚本。

为您的矿工钱包创建一个冷密钥和热密钥。一个冷密钥可以有多个热密钥，因此如果您已经有一个现有的冷密钥，您应该只创建一个新的热密钥。请务必保存您的助记词！

```bash
btcli wallet new_coldkey --wallet.name <钱包>
btcli wallet new_hotkey --wallet.name <钱包> --wallet.hotkey <矿工>
```

您可以使用以下命令列出您机器上的本地钱包。

```bash
btcli wallet list
```

## 2a. 获取测试网TAO

### Discord ###

请向Bittensor Discord社区请求测试网TAO。这将让您在测试网上注册您的矿工。

请首先加入Bittensor Discord：[这里](https://discord.com/invite/bittensor)

然后在[这里](https://discord.com/channels/799672011265015819/1190048018184011867)请求测试网TAO。

Bittensor -> help-forum -> requests for testnet tao

## 3. 注册密钥

此步骤将您的子网矿工密钥注册到子网，为其提供子网上的第一个位置。

```bash
btcli subnet register --wallet.name <钱包> --wallet.hotkey <矿工>
```

要在测试网上注册您的矿工，请添加`--subtensor.network test`和`--netuid 116`标志。

按照以下提示操作：

```bash
>> 输入netuid (0): # 输入您环境的适当netuid（主网为8）
您的余额是: # 将显示您的钱包余额
通过回收注册的成本为τ0.000000001 # 当前注册成本
>> 您要继续吗？[y/n] (n): # 输入y继续
>> 输入密码以解锁密钥: # 输入您的钱包密码
>> 回收τ0.000000001以在子网:8上注册？[y/n]: # 输入y注册
📡 检查余额...
余额:
  τ5.000000000 ➡ τ4.999999999
✅ 已注册
```

## 4. 检查您的密钥是否已注册

此步骤返回有关您已注册密钥的信息。

检查您的矿工是否已注册：

```bash
btcli wallet overview --wallet.name <钱包>
```

要在测试网上检查您的矿工，请添加`--subtensor.network test`标志

上述命令将显示以下内容：

```bash
子网: 8 # 或测试网上的116
冷密钥  热密钥   UID  活跃  质押(τ)     排名    信任  共识  激励  股息  排放(ρ)    V信任  V许可  更新  轴突  热密钥_SS58
钱包   矿工    196    真    0.00000  0.00000  0.00000    0.00000    0.00000    0.00000            0  0.00000        *      134  无  5HRPpSSMD3TKkmgxfF7Bfu67sZRefUMNAcDofqRMb4zpU4S6
1        1        1            τ0.00000  0.00000  0.00000    0.00000    0.00000    0.00000           ρ0  0.00000
                                                                               钱包余额: τ4.998999856
```

## 6. 运行您的矿工

运行子网矿工：

```bash
python neurons/miner.py --netuid 8  --wallet.name <钱包> --wallet.hotkey <矿工> --start-dashboard
```

要在测试网上运行您的矿工，请添加`--subtensor.network test`标志，并将netuuid标志覆盖为`--netuid 116`。

要启用调试日志记录，请添加`--logging.debug`标志

要启用本地矿工仪表板以查看您的统计数据和头寸/订单，请添加`--start-dashboard`标志。

您将看到以下终端输出：

```bash
>> 2023-08-08 16:58:11.223 |       信息       | 正在为子网运行矿工: 8 在网络上: ws://127.0.0.1:9946 使用配置: ...
```

## 7. 停止您的矿工

要停止您的矿工，请在运行矿工的终端中按CTRL + C。

# 运行多个矿工

在测试时，如果您为每个注册的矿工传递不同的端口，您可以使用多个矿工。

您可以使用以下示例命令运行第二个矿工：

```bash
python neurons/miner.py --netuid 116 --subtensor.network test --wallet.name <钱包> --wallet.hotkey <矿工2> --logging.debug --axon.port 8095
```

# 矿工仪表板

## 先决条件

- 包管理器如npm、yarn或pnpm

## 运行仪表板

每个矿工现在都配备了一个仪表板，允许您查看矿工的统计数据和头寸/订单。
要启用仪表板，请在运行矿工时添加`--start-dashboard`标志。
这将安装必要的依赖项，并在http://localhost:5173/上启动应用程序。
打开浏览器并导航到此URL以查看您的矿工仪表板。

## 重要提示

矿工只有在验证器已经接收到其订单后才会拥有数据。
一个全新的矿工可能在下单之前没有任何数据。

矿工仪表板查询并等待验证器的响应。请允许仪表板在启动和刷新时加载一段时间。

## 如果您希望在不同于矿工的机器上查看矿工仪表板：

为了在与矿工不同的机器上查看矿工仪表板，我们建议打开一个ssh隧道到默认端口`41511`和`5173`。如果您在一台机器上运行多个矿工或这些端口繁忙，您可以查看矿工启动日志以确认使用哪些端口。

![Imgur](https://i.imgur.com/9j7bjMR.png)

`41511`由后端矿工数据API使用。

![Imgur](https://i.imgur.com/FnBbScu.png)

`5173`由仪表板前端使用。这是您将在本地机器上连接的内容。

要创建ssh隧道：

```bash
ssh -L [本地端口_1]:localhost:[远程端口_1] -L [本地端口_2]:localhost:[远程端口_2] [矿工]@[地址]
```
例如：
```bash
ssh -L 41511:localhost:41511 -L 5173:localhost:5173 taoshi-miner@123.45.67.89
```
例如，如果您使用Google Cloud VM运行矿工：
```bash
gcloud compute ssh miner1@test-miner1 --zone "[区域]" --project "[项目]" -- -L 5173:localhost:5173 -L 41511:localhost:41511
```

这将把您本地机器上的端口`41511`和`5173`映射到矿工上的相同端口，允许您在本地机器上的http://localhost:5173/查看矿工仪表板。

# 有问题？

如果您遇到问题，请使用`--logging.debug`和`--logging.trace`运行，以便更好地分析为什么您的矿工无法运行。

# 服务条款
我们不允许任何第三方策略在平台上使用，这些策略违反了原始提供商的服务条款。不遵守将导致矿工从平台上移除。
